generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS (em português)
// ============================================

enum CargoUsuario {
  SUPER_ADMIN  // Administrador da plataforma (acesso a todas empresas)
  ADMIN        // Administrador da empresa
  SUPERVISOR
  ATENDENTE
}

enum PlanoEmpresa {
  GRATUITO
  BASICO
  PROFISSIONAL
  EMPRESARIAL
}

enum StatusEmpresa {
  ATIVA
  SUSPENSA
  CANCELADA
}

enum StatusConversa {
  PENDENTE
  EM_ANDAMENTO
  FINALIZADA
}

enum TipoMensagem {
  TEXTO
  IMAGEM
  AUDIO
  VIDEO
  DOCUMENTO
  STICKER
  LOCALIZACAO
  CONTATO
}

enum StatusMensagem {
  PENDENTE
  ENVIADA
  ENTREGUE
  LIDA
  FALHA
}

enum DirecaoMensagem {
  RECEBIDA
  ENVIADA
}

// ============================================
// MODELS (em português)
// ============================================

model Empresa {
  id                String         @id @default(cuid())
  nome              String
  slug              String         @unique
  cnpj              String?        @unique
  email             String
  telefone          String?
  logoUrl           String?
  
  plano             PlanoEmpresa   @default(GRATUITO)
  status            StatusEmpresa  @default(ATIVA)
  
  // Limites do plano
  limiteInstancias  Int            @default(1)
  limiteUsuarios    Int            @default(3)
  limiteConversas   Int            @default(100)
  
  // Datas importantes
  dataAssinatura    DateTime       @default(now())
  dataVencimento    DateTime?
  
  // Relacionamentos
  usuarios          Usuario[]
  instancias        InstanciaWhatsApp[]
  contatos          Contato[]
  conversas         Conversa[]
  respostasRapidas  RespostaRapida[]
  
  criadoEm          DateTime       @default(now())
  atualizadoEm      DateTime       @updatedAt

  @@map("empresas")
}

model Usuario {
  id                String         @id @default(cuid())
  email             String         @unique
  nome              String
  senha             String
  cargo             CargoUsuario   @default(ATENDENTE)
  avatarUrl         String?
  estaOnline        Boolean        @default(false)
  ultimoAcessoEm    DateTime?
  
  // Vínculo com empresa (null para SUPER_ADMIN)
  empresa           Empresa?       @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  empresaId         String?
  
  conversasAtribuidas  Conversa[]     @relation("ConversasAtribuidas")
  mensagensEnviadas    Mensagem[]     @relation("MensagensEnviadas")
  transferenciasOrigem Transferencia[] @relation("TransferenciaOrigem")
  transferenciasDestino Transferencia[] @relation("TransferenciaDestino")
  
  criadoEm          DateTime       @default(now())
  atualizadoEm      DateTime       @updatedAt

  @@index([empresaId])
  @@map("usuarios")
}

model Contato {
  id                String    @id @default(cuid())
  whatsappId        String
  telefone          String
  nome              String?
  fotoPerfilUrl     String?
  
  // Vínculo com empresa
  empresa           Empresa   @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  empresaId         String
  
  conversas         Conversa[]
  
  criadoEm          DateTime  @default(now())
  atualizadoEm      DateTime  @updatedAt

  @@unique([whatsappId, empresaId])
  @@index([empresaId])
  @@map("contatos")
}

model Conversa {
  id                   String         @id @default(cuid())
  protocolo            String         @default(cuid())
  status               StatusConversa @default(PENDENTE)
  
  // Vínculo com empresa
  empresa              Empresa        @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  empresaId            String
  
  contato              Contato        @relation(fields: [contatoId], references: [id])
  contatoId            String
  
  atribuidoPara        Usuario?       @relation("ConversasAtribuidas", fields: [atribuidoParaId], references: [id])
  atribuidoParaId      String?
  
  mensagens            Mensagem[]
  transferencias       Transferencia[]
  
  ultimaMensagemEm     DateTime?
  previewUltimaMensagem String?
  quantidadeNaoLidas   Int            @default(0)
  
  iniciadoEm           DateTime?
  finalizadoEm         DateTime?
  criadoEm             DateTime       @default(now())
  atualizadoEm         DateTime       @updatedAt

  @@unique([protocolo, empresaId])
  @@index([empresaId])
  @@index([status])
  @@index([atribuidoParaId])
  @@index([ultimaMensagemEm])
  @@map("conversas")
}

model Mensagem {
  id                   String          @id @default(cuid())
  whatsappMensagemId   String?         @unique
  
  conteudo             String?
  tipo                 TipoMensagem    @default(TEXTO)
  direcao              DirecaoMensagem
  status               StatusMensagem  @default(PENDENTE)
  
  midiaUrl             String?
  midiaTipo            String?
  midiaTamanho         Int?
  midiaNome            String?
  
  conversa             Conversa        @relation(fields: [conversaId], references: [id], onDelete: Cascade)
  conversaId           String
  
  remetente            Usuario?        @relation("MensagensEnviadas", fields: [remetenteId], references: [id])
  remetenteId          String?
  
  criadoEm             DateTime        @default(now())
  atualizadoEm         DateTime        @updatedAt

  @@index([conversaId])
  @@index([criadoEm])
  @@map("mensagens")
}

model Transferencia {
  id                String    @id @default(cuid())
  
  conversa          Conversa  @relation(fields: [conversaId], references: [id])
  conversaId        String
  
  deUsuario         Usuario   @relation("TransferenciaOrigem", fields: [deUsuarioId], references: [id])
  deUsuarioId       String
  
  paraUsuario       Usuario   @relation("TransferenciaDestino", fields: [paraUsuarioId], references: [id])
  paraUsuarioId     String
  
  motivo            String?
  
  criadoEm          DateTime  @default(now())

  @@map("transferencias")
}

model InstanciaWhatsApp {
  id                String    @id @default(cuid())
  nomeInstancia     String
  instanciaId       String?
  status            String    @default("desconectado")
  qrCode            String?
  telefone          String?
  
  // Vínculo com empresa
  empresa           Empresa   @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  empresaId         String
  
  criadoEm          DateTime  @default(now())
  atualizadoEm      DateTime  @updatedAt

  @@unique([nomeInstancia, empresaId])
  @@index([empresaId])
  @@map("instancias_whatsapp")
}

model RespostaRapida {
  id                String    @id @default(cuid())
  atalho            String
  titulo            String
  conteudo          String
  
  // Vínculo com empresa
  empresa           Empresa   @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  empresaId         String
  
  criadoEm          DateTime  @default(now())
  atualizadoEm      DateTime  @updatedAt

  @@unique([atalho, empresaId])
  @@index([empresaId])
  @@map("respostas_rapidas")
}
